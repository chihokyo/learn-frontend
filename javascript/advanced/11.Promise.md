# Promise

## 1. å†å²

å†å²é—®é¢˜ã€‚é‚£ä¹ˆ JavaScript æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

JS æ˜¯å•çº¿ç¨‹çš„ï¼Œå°±æ˜¯æ’é˜Ÿä¸Šå•æ‰€ã€‚ä½†æ˜¯æœ‰æ—¶å€™ç­‰ä¸äº†æ€ä¹ˆåŠï¼Œæ¯”å¦‚è¯´å¤§çš„æ–‡ä»¶çš„ä¸‹è½½ï¼ŒæˆåŠŸäº†è¿˜å¤±è´¥äº†ï¼Ÿæˆ‘éš¾é“å¿…é¡»ç­‰ä½ å…¨éƒ¨ä¸‹è½½å®Œï¼ˆæˆåŠŸå¤±è´¥æœªå®šï¼‰æ‰èƒ½å¹²å…¶ä»–äº‹æƒ…å—ï¼Ÿè¿™äº›éƒ½æ˜¯å¥½è€—æ—¶çš„ï¼Œç­‰ä¸èµ·çš„ï¼

ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ä¾‹å­ã€‚

```js
function requestData(url) {
  setTimeout(() => {
    if (url === 'request') {
      let data = [1, 2, 3];
      return data;
    } else {
      let errMsg = 'error';
      return errMsgl;
    }
  }, 2000);
}

console.log(requestData('request')); // undefined
```

2 ç§’ä¹‹åä»€ä¹ˆéƒ½ä¸ä¼šè¿”å›ï¼Œå› ä¸ºå¾ˆç®€å•ï¼Œ`setTimeout()`é‡Œçš„å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚è€Œ`requestData()`æ˜¯åŒæ­¥è°ƒç”¨ã€‚

`requestData()`å¯èƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯å›è°ƒå‡½æ•°ç”±äºæ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”æ˜¯å®ä»»åŠ¡ã€‚æ‰€ä»¥ä¸ä¼šæŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºæ‰§è¡Œï¼Œè¿™ä¸ªå¯ä»¥ç›´æ¥çœ‹**äº‹ä»¶å¾ªç¯**ã€‚

æ‰€ä»¥è¿™é‡Œè®¾è®¡äº†ä¸€ä¸ªå›è°ƒå‡½æ•°

> _åˆ©ç”¨å›è°ƒå‡½æ•°_
>
> æœ‰ç»“æœçš„æ—¶å€™é€šè¿‡**å›è°ƒå‡½æ•°**æ¥æ¥æ”¶**ç»“æœ**

```js
function requestData(url, sucCb, failCb) {
  // setTimeoutä¸ä¼šé©¬ä¸Šç»™ä½ ç»“æœï¼Œåˆ©ç”¨å›è°ƒå‡½æ•°
  // æœ‰ç»“æœçš„æ—¶å€™é€šè¿‡å›è°ƒå‡½æ•°æ¥æ¥æ”¶
  setTimeout(() => {
    if (url === 'request') {
      let data = [1, 2, 3, 4];
      sucCb(data);
    } else {
      failCb('error');
    }
  });
}

requestData(
  'request',
  (res) => {
    console.log(res);
  },
  (err) => {
    console.log(err);
  }
);
// [ 1, 2, 3, 4 ]

requestData(
  'error',
  (res) => {
    console.log(res);
  },
  (err) => {
    console.log(err);
  }
);
// error
```

![image-20220422132526348](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422132526348.png)

### å¼Šç«¯

- è®¾è®¡å‡½æ•°çš„æ—¶å€™å¤ªè‡ªç”±ï¼Œ`function requestData(url, sucCb, failCb)` åˆ«äººå¯èƒ½æŠŠ url æ”¾å…¥åˆ°ç¬¬ 3 ä¸ªä½ç½®ï¼Œå¯èƒ½å‡½æ•°åä¹Ÿä¸çŸ¥é“æ˜¯å•¥
- è°ƒç”¨è€…ä¹Ÿéº»çƒ¦ã€‚æ¯æ¬¡éƒ½è¦çœ‹ä¸€ä¸‹æ˜¯ä»€ä¹ˆå‡½æ•°

### è§£å†³

é‚£æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿå¦‚æœå­˜åœ¨ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»åŒ…å«äº†æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒã€‚å¦‚ä¸‹ ğŸ‘‡ğŸ»

```js
function requestData(url) {
  const alarm = new Alarm(); // â‘  æ–°å»ºä¸€ä¸ªç±»
  setTimeout(() => {
    if (url === 'request') {
      let data = [1, 2, 3, 4];
      alarm.success(data); // â‘¡ æˆåŠŸçš„å‡½æ•°
    } else {
      let errMsg = 'error';
      alarm.fail(errMsg); // â‘¢ æˆåŠŸçš„å‡½æ•°
    }
  });
  return alarm; // â‘£ è¿”å›è¿™ä¸ªç±»
}
```

ä½†æ˜¯è¿™ä¸ªä¹Ÿä¸è¡Œå•Šï¼ŒAlarm ç±»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

äºæ˜¯ ES æäº†ä¸€ä¸ªè§„èŒƒï¼Œå°±æ˜¯æ‰€æœ‰äººéƒ½è¦éµå®ˆçš„ã€‚**è¿™ä¸ªå°±æ˜¯ Promise**ã€‚

- ä¸Šé¢çš„`Alarm`æ¢æˆ Promise
- `new Promise((resolve,reject) => {})`
- æˆåŠŸå›è°ƒ`resolve,resolve`ä¼šç«‹å³æ‰§è¡Œ `then`
- å¤±è´¥å›è°ƒ`reject,reject`ä¼šç«‹å³æ‰§è¡Œ `catch`

```js
function requestData(url) {
  // â‘  æŠŠä½ æƒ³è¦å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ç›´æ¥æ”¾è¿›new Promiseé‡Œ
  const promise = new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url === 'request') {
        let data = [1, 2, 3, 4];
        resolve(data); // â‘¡ æˆåŠŸçš„å‡½æ•°
      } else {
        let errMsg = 'error';
        reject(errMsg); // â‘¢ æˆåŠŸçš„å‡½æ•°
      }
    });
  });

  return promise; // â‘£ è¿”å›è¿™ä¸ªç±»
}

const promise = requestData('requ1est');
promise.then((value) => {
  console.log(value);
});
promise.catch((error) => {
  console.log(error);
});

// ä¹Ÿå¯ä»¥å†™æˆè¿™æ · é“¾å¼è°ƒç”¨çš„å½¢å¼

promise
  .then((value) => {
    console.log(value);
  })
  .catch((error) => {
    console.log(error);
  });
```

## 2. API ä»‹ç»

`Promise` æ˜¯ä¸€ä¸ªç±»ï¼ˆæ„é€ å‡½æ•°ï¼‰

- ç»™è°ƒç”¨è€…ä¸€ä¸ªæ‰¿è¯ºï¼ˆæ–°å»ºä¸€ä¸ª`new Promise()`ï¼‰
- åˆ›å»ºçš„æ—¶å€™éœ€è¦æ”¾è¿›å»ä¸€ä¸ªå›è°ƒå‡½æ•° `new Promise(exector)`

> Promise æ˜¯ä¸€ä¸ªç±»ï¼Œå¯ä»¥ç¿»è¯‘æˆ æ‰¿è¯ºã€è®¸è¯º ã€æœŸçº¦;
> å½“æˆ‘ä»¬éœ€è¦çš„æ—¶å€™ï¼Œç»™äºˆè°ƒç”¨è€…ä¸€ä¸ªæ‰¿è¯ºã€‚å¾…ä¼šå„¿æˆ‘ä¼šç»™ä½ å›è°ƒæ•°æ®æ—¶ï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ª Promise çš„å¯¹è±¡ã€‚
>
> åœ¨é€šè¿‡ new åˆ›å»º Promise å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**executor**
>
> - è¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”ç»™ä¼ å…¥å¦å¤–ä¸¤ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°**resolveã€reject**
> - å½“æˆ‘ä»¬è°ƒç”¨**resolve**å›è°ƒå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œ Promise å¯¹è±¡çš„**then**æ–¹æ³•ä¼ å…¥çš„å›è°ƒå‡½æ•°
> - å½“æˆ‘ä»¬è°ƒç”¨ **reject** å›è°ƒå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œ**Promise**å¯¹è±¡çš„**catch**æ–¹æ³•ä¼ å…¥çš„å›è°ƒå‡½æ•°

ä¸Šé¢åªæ˜¯ä¸€ä¸ªæ¦‚è¿°ï¼Œå…·ä½“è¿˜æ˜¯è¦çœ‹ä»£ç ã€‚

Executor æ˜¯åœ¨åˆ›å»º Promise æ—¶éœ€è¦ä¼ å…¥çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”ä¼ å…¥ä¸¤ä¸ªå‚æ•°

```js
new Promise((resolve, reject) => {
  console.log('exectorä»£ç ');
});
```

![image-20220422134458062](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422134458062.png)

ç„¶åå°±å¯ä»¥æŠŠä¸Šé¢é‚£æ®µä»£ç ç”¨`Promise`æ¥é‡æ„äº†

![img](https://raw.githubusercontent.com/chihokyo/image_host/develop/sp20220422_135735_489.png)

ç„¶åå°±å¯ä»¥ç›´æ¥ç”¨äº†

```javascript
const promise = requestData('request1');

promise
  .then(() => {
    console.log('success');
  })
  .catch(() => {
    console.log('failed');
  });

// è¿™æ ·å†™ä¹Ÿå¯ä»¥ thené‡Œé¢2ä¸ªå›è°ƒå‡½æ•°ï¼Œ1ä¸ªæˆåŠŸï¼Œ1ä¸ªå¤±è´¥
promise.then(
  () => {
    console.log('success');
  },
  () => {
    console.log('failed');
  }
);

// è¿™æ ·ç›´æ¥å†™ä¹Ÿå¯ä»¥
new requestData((resolve, reject) => {
  console.log('------');
  resolve();
  reject();
})
  .then((res) => {
    console.log(res);
  })
  .catch((err) => {
    console.log(err);
  });
```

äºæ˜¯å·®ä¸å¤šæœ€åçš„ç»“æœå°±æ˜¯

```javascript
const p1 = new Promise((resolve, reject) => {
  const data = [
    { id: 'uuid1', age: 99 },
    { id: 'uuid2', age: 10 },
  ];
  const errMsg = 'failed';
  let flag = false;
  if (flag) {
    resolve(data);
  } else {
    reject(errMsg);
  }
});

p1.then((res) => {
  console.log(res);
}).catch((err) => {
  console.log(err);
});
```

### çŠ¶æ€

> é¦–å…ˆè¦æœ‰ä¸€ä¸ªä¸œè¥¿è¦çŸ¥é“ï¼ŒPromiseä¸€æ—¦çŠ¶æ€ç¡®å®šï¼Œå°±æ— æ³•æ›´æ”¹ã€‚
>
> ä¹Ÿä¸èƒ½å†æ¬¡æ‰§è¡ŒæŸä¸ªå›è°ƒæ”¹å˜çŠ¶æ€ã€‚

- pending
- fulfilled
- rejected

![image-20220422140804125](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422140804125.png)

çŠ¶æ€ä¸€æ—¦ç¡®å®šï¼Œå°±æ— æ³•æ›´æ”¹ï¼Œå°±æ˜¯è¢«é”ä½çš„ã€‚

```javascript
new requestData((resolve, reject) => {
  console.log('------');
  resolve(); // fulfilledçŠ¶æ€
  // reject(); âŒ è¿™ä¸ªæ—¶å€™å·²ç»æ•²å®šäº† resolve ï¼Œåœ¨æ¥ reject æ˜¯æ²¡æ„ä¹‰çš„
})
  .then((res) => {
    console.log(res);
  })
  .catch((err) => {
    console.log(err);
  });
```

## 3. resolve()

æœ€å¸¸è§æœ€åŸºç¡€çš„ç”¨æ³•å°±æ˜¯é‡Œé¢ç›´æ¥æ”¾ä¸€ä¸ªä½ æƒ³ä¼ é€’çš„æ•°æ®ï¼ˆå¤§å¤šæ•°æ˜¯å¯¹è±¡ or æ•°ç»„ï¼‰ã€‚è¿™æ˜¯æœ€åŸºç¡€çš„ç”¨æ³•ï¼Œä¸Šé¢éƒ½æ˜¯è¿™ç§ã€‚ä½†æ˜¯çœŸæ­£å†™èµ·æ¥ä¼šæœ‰ä¸€äº›åˆ«çš„ç”¨æ³•ã€‚

### æ™®é€šå€¼ or æ™®é€šå¯¹è±¡

ä¸è¯´äº†ï¼Œä¸Šé¢éƒ½æ˜¯ã€‚

### å¸¦æœ‰ then å±æ€§çš„å¯¹è±¡

å¸¦æœ‰thenå±æ€§çš„å¯¹è±¡ï¼Œè¿™ä¸ªå°±æ˜¯ thenable äº†ã€‚

```js
function requestData(url) {
  return new Promise((resolve, reject) => {
    if (url === 'request') {
      resolve({
        id: 'test_then',
        then: function (resolve, reject) {
          resolve('aaa'); // ğŸ‘ˆğŸ» è¿™é‡Œå†³å®šçš„
        },
      });
    }
  });
}
requestData('request').then((res) => {
  console.log(res);
});
```

### å¸¦ä¸€ä¸ªæ–°çš„ new Promise

å…¶å®å°±æ˜¯æ ¹æ®è¿™ä¸ªæ–°çš„ Promise çŠ¶æ€æ¥å†³å®šæœ€åçš„ç»“æœ

```js
function requestData(url) {
  return new Promise((resolve, reject) => {
    if (url === 'request') {
      resolve(
        new Promise((resolve, reject) => {
          reject('error'); //ğŸ‘ˆğŸ»å§ æ ¹æ®è¿™ä¸ªå®šçš„ è¿™é‡Œæ˜¯å•¥ ç»“æœå°±æ˜¯å•¥
        })
      );
    }
  });
}
requestData('request')
  .then((res) => {
    console.log(res);
  })
  .catch((err) => {
    console.log(err);
  });
```

ä¸‹é¢æ˜¯ä¸€ä¸ªå›¾çš„ï¼ŒåŠ©ç†è§£ã€‚

![image-20220422151915827](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422151915827.png)

## 4. then()	

å…³äº`then()`æ–¹æ³•

é¦–å…ˆ then æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼Œç„¶åå¯ä»¥éªŒè¯å‡ºæ¥

```javascript
// ç›´æ¥æ‰“å°æ˜¯å‡ºä¸æ¥çš„ ï¼Œå› ä¸ºå¯ä»¥çœ‹åˆ° enumerable: false,
console.log(Object.getOwnPropertyDescriptors(Promise.prototype));
```

ç»“æœå°±æ˜¯

```json
{
  length: { value: 1, writable: false, enumerable: false, configurable: true },
  name: {
    value: 'Promise',
    writable: false,
    enumerable: false,
    configurable: true
  },
  prototype: {
    value: Object [Promise] {},
    writable: false,
    enumerable: false,
    configurable: false
  },
  all: {
    value: [Function: all],
    writable: true,
    enumerable: false,
    configurable: true
  },
  allSettled: {
    value: [Function: allSettled],
    writable: true,
    enumerable: false,
    configurable: true
  },
  any: {
    value: [Function: any],
    writable: true,
    enumerable: false,
    configurable: true
  },
  race: {
    value: [Function: race],
    writable: true,
    enumerable: false,
    configurable: true
  },
  resolve: {
    value: [Function: resolve],
    writable: true,
    enumerable: false,
    configurable: true
  },
  reject: {
    value: [Function: reject],
    writable: true,
    enumerable: false,
    configurable: true
  },
  [Symbol(Symbol.species)]: {
    get: [Function: get [Symbol.species]],
    set: undefined,
    enumerable: false,
    configurable: true
  }
}
```

### å¯è¢«å¤šæ¬¡è°ƒç”¨

å½“ `resolve()` æ–¹æ³•è¢«å›è°ƒæ—¶, æ‰€æœ‰çš„ `then()` æ–¹æ³•ä¼ å…¥çš„å›è°ƒå‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨

```javascript
const thenPromise = new Promise((resolve, reject) => {
  resolve('then test');
});

thenPromise.then((res) => {
  console.log('res1', res);
});
thenPromise.then((res) => {
  console.log('res2', res);
});
thenPromise.then((res) => {
  console.log('res3', res);
});
```

é‚£ä¹ˆå†æ¥æ¯”è¾ƒä¸€ä¸‹ä¸‹é¢è¿™ä¸¤è€…

![image-20220422233031775](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422233031775.png)

### è¿”å›å€¼ 3 ç§æƒ…å†µ

äºæ˜¯å°±å¼•å‡ºäº†æ–°çš„é—®é¢˜ï¼Œå°±æ˜¯ç¬¬äºŒæ®µ Promise çš„é—®é¢˜ã€‚

`then()` æœ‰æ²¡æœ‰è¿”å›å€¼çš„é—®é¢˜ã€‚ç»“è®ºå°±æ˜¯æœ‰çš„ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„`new Promise()`ä½†æ˜¯åˆ†ä¸‰ç§æƒ…å†µã€‚å› ä¸º then æœ¬èº«è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª Promiseï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨é“¾å¼è°ƒç”¨ã€‚

å…ˆè¯´ä¸€ä¸‹åŸç†+ç¬¬ä¸€ç§æƒ…å†µ

![image-20220422233703276](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422233703276.png)

ç„¶åæ˜¯å‰©ä¸‹ 2 ç§

![image-20220422234853081](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220422234853081.png)

```js
// ç¬¬2ç§
const testThen2 = new Promise((resolve, reject) => {
  resolve('aa');
});

testThen2
  .then((res) => {
    return new Promise((resolve) =>
      setTimeout(() => {
        resolve(res);
      }, 2000)
    );
  })
  .then((res) => {
    console.log(res); // 2ç§’åæ‰“å°aa
  });

// ç¬¬3ç§
const testThen3 = new Promise((resolve, reject) => {
  resolve('aaa');
});

testThen3
  .then(() => {
    return {
      then: function (resolve, reject) {
        resolve('bbb');
      },
    };
  })
  .then((res) => console.log(res));
```

å¯ä»¥ catch ä¸€èµ·å†™ï¼Œå¯ä»¥åˆ†å¼€å†™ã€‚

```js
const p = new Promise((resolve, reject) => {
  resolve(1);
  //   reject("error")
});
// åˆ†å¼€å†™
p.then(() => {}).catch(() => {});
// ä¸€èµ·å†™ â†’ æ•ˆæœæ˜¯ä¸€æ ·çš„
p.then(
  () => {},
  () => {}
);
```

## 5. catch()

`catch()`ä¹Ÿæ˜¯ä¼šè¿”å›ä¸€ä¸ª Promise çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨`then()`è·Ÿ`catch()`çš„ã€‚

```js
const p = new Promise((resolve, reject) => {
  reject('error');
});
p.catch((err) => {
  console.log(err); // err
  return '11';
}).then((res) => console.log(res)); // 11
```

å…³äº `catch()` æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹

![image-20220424225510796](https://raw.githubusercontent.com/chihokyo/image_host/develop/image-20220424225510796.png)

å¦å¤–è¿™å°±äº§ç”Ÿäº†ç‹¬ç«‹è°ƒç”¨çš„é—®é¢˜

catch å¯ä»¥åœ¨ä¸å†™ then çš„æ—¶å€™ç‹¬ç«‹å†™å—ï¼Ÿ

```javascript
const cPromise = new Promise((resolve, reject) => {
  // resolve(11);
  reject(22);
});

cPromise.then((res) => {});
// è¿™é‡Œä¼šæŠ¥é”™ ä¸ºä»€ä¹ˆï¼Ÿ
// å› ä¸ºå¦‚æœç›¸å¯¹ç‹¬ç«‹çš„è¯ï¼Œ ğŸ‘† æ ¹æœ¬æ²¡æœ‰å®ç° reject() æ—¶å€™çš„å¤„ç†
// âŒ è¿™æ ·ç‹¬ç«‹å†™åœ¨å¤–é¢ä¼šæ˜¾ç¤ºæŠ¥é”™ã€‚
cPromise.catch((err) => {
  console.log(err);
});
```

ä¹Ÿå°±æ˜¯è¯´ä½ è¿™æ ·å†™æ˜¯å¯ä»¥çš„

```js
const p = new Promise((resolve, reject) => {
  reject('error');
});
p.catch((err) => {
  console.log('err1', err);
});
p.catch((err) => {
  console.log('err2', err);
});
p.catch((err) => {
  console.log('err3', err);
});
```

ä½†æ˜¯è¿™æ ·å†™ä¸å¯ä»¥

```js
const p = new Promise((resolve, reject) => {
  reject('error');
});
// âŒ
p.then((res) => {
  console.log('res', res);
});
p.catch((err) => {
  console.log('err1', err);
});
p.catch((err) => {
  console.log('err2', err);
});
p.catch((err) => {
  console.log('err3', err);
});
```

### æ•è·å¼‚å¸¸

åªè¦æœ‰ä¸€ä¸ª`catch()`åœ¨æœ€åï¼Œä¸Šé¢æ‰€æœ‰çš„ Promise éƒ½å¯ä»¥è¢« catch åˆ°ã€‚è™½ç„¶å¤§å®¶çš„ Promise éƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯åªè¦æœ‰ä¸€ä¸ª catch å°±å¯ä»¥ cat åˆ°å…¨éƒ¨çš„

```js
const p = new Promise((resolve, reject) => {
  reject('error');
});
// è™½ç„¶catchå†™åœ¨äº†æœ€åï¼Œå¹¶ä¸”ä¸‹é¢ä»£ç 2ä¸ªæ–°çš„Promise
// ä¸Šé¢æ˜¯ä¸€ä¸ªPromiseï¼Œæ€»å…±3ä¸ªä¸åŒçš„Promiseã€‚
// ä½†æ˜¯éƒ½ä¼šè¢«æœ€åä¸€ä¸ªcatchåˆ°
p.then((res) => {
  console.log(res);
})
  .then((res) => {
    console.log(re);
  })
  .catch((err) => {
    console.log(err);
  });
```

å¹¶ä¸” catch ä¼šæ•è·ä»ä¸Šåˆ°ä¸‹çš„å…¨éƒ¨å¼‚å¸¸ã€‚å…œåº•ä¸€æ ·ã€‚

é‚£ä¹ˆå¦‚æœåœ¨`then()`é‡Œé¢å‘ç”Ÿäº†å¼‚å¸¸æ€ä¹ˆåŠï¼Ÿéš¾é“å†™ rejectï¼Ÿ

```js
const p = new Promise((resolve, reject) => {
   resolve(11);
});
p.then((res) => {
 âŒ rejectr(erro)ï¼Ÿ
  console.log(res);
})
  .then((res) => {
    console.log(re);
  })
  .catch((err) => {
    console.log(err);
  });

// æ­£ç¡®æ•è·æ–¹å¼

const p = new Promise((resolve, reject) => {
  resolve(11);
});
p.then((res) => {
  throw new Error('error');
  console.log(res);
})
  .then((res) => {
    console.log(re);
  })
  .catch((err) => {
    console.log(err);
  });

```

```javascript
const cPromise = new Promise((resolve, reject) => {
  resolve();
});

cPromise
  .then((res) => {})
  .then((res) => {
    throw new Error('then error message');
  })
  .catch((err) => {
    console.log('err:', err); // err: Error: then error message
  });
```

### è¿”å›å€¼

é‚£ä¹ˆ `catch()` æœ‰æ²¡æœ‰è¿”å›å€¼ï¼Ÿ

`catch()`ä¹Ÿæ˜¯ä¼šè¿”å›ä¸€ä¸ª Promise çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨`then()`è·Ÿ`catch()`çš„ã€‚

```javascript
const cPromise = new Promise((resolve, reject) => {
  reject('111');
});

cPromise
  .then((res) => {
    console.log('res:', res);
  })
  .catch((err) => {
    console.log('err:', err); // err: 111
    // ç­”æ¡ˆå°±æ˜¯æœ‰çš„ åŸç†å’Œä¸Šé¢ä¸€æ ·
    // return å›æ¥çš„å…¶å®ä¸€ä¸ªPromiseæ–°çš„resolve
    return 'catch return value';
  })
  .then((res) => {
    console.log('res result:', res); // res result: catch return value
  })
  .catch((err) => {
    console.log('err result:', err);
  });
```

åŸºæœ¬ç»“è®ºå°±æ˜¯è¿™äº›å¸¦

## 6. finally()

ES9 æ–°å¢çš„ï¼Œä»¥å‰æ²¡æœ‰ã€‚æ— è®º Promise æ˜¯ fulfilled è¿˜æ˜¯ rejected çŠ¶æ€ã€‚finally éƒ½ä¼šè¢«æ‰§è¡Œã€‚

åœ¨æ²¡æœ‰ finally ä¹‹å‰ï¼Œè¦æƒ³å®ç°è¿™ä¸ªæ— è®ºæˆåŠŸ or å¤±è´¥éƒ½ä¼šè¢«æ‰§è¡Œçš„é€»è¾‘ã€‚

æ˜¯éœ€è¦å†™ã€‚

```js
const finallyPromise = new Promise((resolve, reject) => {
  resolve(11);
  //   reject(22);
});

finallyPromise
  .then((res) => {
    console.log('res', res);
    foo();
  })
  .catch((err) => {
    console.log('err', err); // err 22
    foo();
  });

function foo() {
  console.log('æ— è®ºæˆåŠŸå¤±è´¥æˆ‘éƒ½ä¼šæ‰§è¡Œçš„ï¼'); // æ— è®ºæˆåŠŸå¤±è´¥æˆ‘éƒ½ä¼šæ‰§è¡Œçš„ï¼
}
```

æœ‰äº† finally ä¹‹å

```js
const finallyPromise = new Promise((resolve, reject) => {
  // resolve(11);
  reject(22);
});

finallyPromise
  .then((res) => {
    console.log('res', res);
  })
  .catch((err) => {
    console.log('err', err); // err 22
  })
  .finally(() => {
    console.log('æ— è®ºæˆåŠŸå¤±è´¥æˆ‘éƒ½ä¼šæ‰§è¡Œçš„ï¼'); // æ— è®ºæˆåŠŸå¤±è´¥æˆ‘éƒ½ä¼šæ‰§è¡Œçš„ï¼
  });
```

## 7. Promise.xxx ç±»æ–¹æ³•

### 7-1 Promise.resolve()

é¦–å…ˆè¦äº†è§£ JS æœ‰å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•çš„åŒºåˆ«ã€‚è¿™è·Ÿ java çš„ static é™æ€æ–¹æ³•ï¼Œå’Œæ™®é€šæ–¹æ³•åŒºåˆ«å·®ä¸å¤šã€‚ç±»æ–¹æ³•å°±æ˜¯æŒ‚è½½åœ¨ç±»ä¸Šé¢çš„ã€‚ä¸ç”¨å®ä¾‹åŒ–ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚JS çš„ç±»æ–¹æ³•éƒ½æ˜¯åœ¨`Promise.prototype`ä¸Šçš„ã€‚

```js
// å®ä¾‹æ–¹æ³•
const promise = new Promise((resolve) => {
  resolve(11);
});

// ç±»æ–¹æ³•
Promise.resolve();
```

é‚£ä¹ˆè¿™ä¸ª`Promise.resolve();`ç±»æ–¹æ³•æ˜¯ä»€ä¹ˆå‘¢

ä¸»è¦ç”¨äºåªæœ‰æˆåŠŸ resolve çš„æ—¶å€™ï¼Œå¿«é€Ÿå°±å†™å‡ºæ¥äº†ã€‚ä¸å¿…å®ä¾‹åŒ–äº†ã€‚

```js
Promise.resolve(11).then((res) => {
  console.log(res);
});
```

ä¸Šé¢çš„ä»£ç å°±ç›¸å½“äº

```js
const promise = new Promise((resolve) => {
  resolve(11);
});
promise.then((res) => {
  console.log(res);
});
```

å¯ä»¥æ›´ç®€æ´ï¼Œæ›´å¥½ã€‚

#### ç”¨é€”

ä¸»è¦ç”¨äºå·²ç»æœ‰äº†ä¸€ä¸ªå†…å®¹ï¼Œæƒ³è½¬æ¢æˆ Promise å¯¹è±¡ã€‚

ä»¥å‰éƒ½æ˜¯ä¸€ç³»åˆ—æ“ä½œï¼Œæ¯”å¦‚å¼‚æ­¥è¯·æ±‚ï¼Œä¼šæ–°å»ºä¸€ä¸ª Promiseã€‚å¦‚æœå·²ç»æœ‰äº†ä¸€ä¸ªç»“æœäº†ï¼Œå¯èƒ½è¯»å–æ˜¯æœ¬åœ°çš„æ–‡ä»¶ã€‚ç„¶åä½¿ç”¨ promise è¿”å›å‡ºå»ã€‚è¿™æ ·æ²¡æœ‰å¿…è¦æ–°å»ºä¸€ä¸ª Promise å¯¹è±¡ã€‚

```js
// before
const data = ['aa', 'bb', 'cc'];
const promise = new Promise((resolve) => {
  resolve(data);
}).then((res) => {
  console.log(res);
});

// ğŸ†•
const data = ['aa', 'bb', 'cc'];
Promise.resolve(data).then((res) => {
  console.log(res);
});
```

### 7-2 Promise.all()

æ¦‚å¿µï¼Œall é‡Œé¢æ”¾çš„æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚

`Promise.all()`è¿™ä¸ª Promise çš„çŠ¶æ€ï¼Œæ˜¯ç”± p1,p2,p3 å†³å®šçš„ã€‚

åªè¦æœ‰ 1 ä¸ªè¢« rejected äº†ï¼Œæ•´ä½“å°±æ˜¯å¤±è´¥äº†ã€‚

å…¨éƒ¨éƒ½æ˜¯ fulfilledï¼Œæ‰æ˜¯ fulfilledã€‚

```js
const p1 = new Promise((resolve, reject) => {
  resolve(11);
});

const p2 = new Promise((resolve, reject) => {
  resolve(22);
});

const p3 = new Promise((resolve, reject) => {
  resolve(33);
});

// è¿™ä¸ªPromiseçš„ç»“æœæ˜¯ç”±p1,p2,p3çš„ç»“æœæ¥å†³å®šçš„
Promise.all([p1, p2, p3]).then((res) => {
  console.log(res); // [ 11, 22, 33 ]
});
```

### 7-3 Promise.allSettled()

ç•¥ï¼Œå¾ˆç®€å•ã€‚å¯¹æ¯” all æ¥çœ‹ã€‚

### 7-4 Promise.race()

ç•¥ï¼Œå¾ˆç®€å•ã€‚å¯¹æ¯” any æ¥çœ‹ã€‚

### 7-5 Promise.any()

ç•¥ï¼Œå¾ˆç®€å•ã€‚å¯¹æ¯” any æ¥çœ‹ã€‚